name: üîÑ Atualizar Eventos Sympla (3 Tipos)

on:
  # Executa manualmente
  workflow_dispatch:
    inputs:
      force_update:
        description: 'For√ßar atualiza√ß√£o mesmo sem mudan√ßas'
        required: false
        default: 'false'
  
  # Executa automaticamente a cada 6 horas
  schedule:
    - cron: '0 */6 * * *'  # 00:00, 06:00, 12:00, 18:00 UTC
    
  # Executa quando h√° push na branch main (opcional)
  push:
    branches: [ main ]
    paths: 
      - 'sympla_processor.py'
      - '.github/workflows/update-events.yml'

jobs:
  update-events:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: üîë Verify Sympla API Key
      env:
        SYMPLA_API_KEY: ${{ secrets.SYMPLA_API_KEY }}
      run: |
        if [ -z "$SYMPLA_API_KEY" ]; then
          echo "‚ùå SYMPLA_API_KEY n√£o configurada!"
          echo "üëâ V√° em Settings > Secrets > Actions"
          echo "üëâ Adicione SYMPLA_API_KEY com sua chave da API Sympla"
          exit 1
        fi
        echo "‚úÖ SYMPLA_API_KEY encontrada"
        
    - name: üì° Fetch events from Sympla API
      env:
        SYMPLA_API_KEY: ${{ secrets.SYMPLA_API_KEY }}
      run: |
        echo "üöÄ Iniciando busca de eventos..."
        python sympla_processor.py
        
        # Verifica se o arquivo foi gerado
        if [ ! -f events-data.json ]; then
          echo "‚ùå Falha ao gerar events-data.json"
          exit 1
        fi
        
        echo "‚úÖ Eventos processados com sucesso"
        
        # Mostra estat√≠sticas
        echo "üìä Estat√≠sticas dos eventos:"
        python -c "
        import json
        with open('events-data.json') as f:
            data = json.load(f)
        print(f'‚Ä¢ Total: {data[\"total_events\"]} eventos')
        print(f'‚Ä¢ Igreja da Penha: {data[\"penha_events_count\"]} eventos')  
        print(f'‚Ä¢ Outras Igrejas: {data[\"outras_events_count\"]} eventos')
        print(f'‚Ä¢ Cursos de Noivos: {data[\"noivos_events_count\"]} eventos')
        print(f'‚Ä¢ √öltima atualiza√ß√£o: {data[\"generated_at\"]}')
        "
        
    - name: üìÑ Generate HTML files
      run: |
        echo "üìù Gerando arquivos HTML..."
        
        python << 'EOF'
        import json
        from datetime import datetime
        
        # Carrega dados dos eventos
        with open('events-data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # Template HTML principal com 3 se√ß√µes
        main_template = f"""<!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Eventos Sympla - Igreja da Penha</title>
            <meta name="description" content="Cursos Online - Igreja da Penha">
            <style>
                body {{
                    margin: 0;
                    padding: 0;
                    background: transparent;
                    font-family: 'Montserrat', sans-serif;
                }}
                .container {{
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                    text-align: center;
                }}
                .event-section {{
                    margin-bottom: 40px;
                    background: transparent;
                }}
                .section-title {{
                    font-family: 'Montserrat', sans-serif;
                    font-weight: 900;
                    color: #003448;
                    font-size: 24px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    margin-bottom: 30px;
                    text-align: center;
                }}
                .info {{
                    text-align: center;
                    padding: 20px;
                    background: rgba(248, 249, 250, 0.8);
                    border-radius: 15px;
                    color: #6b7280;
                    font-size: 12px;
                    font-family: 'Montserrat', sans-serif;
                    margin-top: 30px;
                }}
                @media (max-width: 768px) {{
                    .container {{ padding: 10px; }}
                    .section-title {{ font-size: 20px; }}
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="event-section">
                    <h2 class="section-title">üèõÔ∏è Igreja da Penha</h2>
                    {data['html_penha']}
                </div>
                
                <div class="event-section">
                    <h2 class="section-title">‚õ™ Outras Igrejas</h2>
                    {data['html_outras']}
                </div>
                
                <div class="event-section">
                    <h2 class="section-title">üíí Cursos de Noivos</h2>
                    {data['html_noivos']}
                </div>
                
                <div class="info">
                    <p>üì° Atualizado automaticamente via GitHub Actions</p>
                    <p>üîÑ √öltima atualiza√ß√£o: {data['generated_at']}</p>
                    <p>üìä Pais/Padrinhos: {data['penha_events_count'] + data['outras_events_count']} ‚Ä¢ Noivos: {data['noivos_events_count']} ‚Ä¢ Total: {data['total_events']}</p>
                </div>
            </div>
        </body>
        </html>"""
        
        # Salva index.html principal
        with open('index.html', 'w', encoding='utf-8') as f:
            f.write(main_template)
        
        # Salva arquivos separados
        with open('penha.html', 'w', encoding='utf-8') as f:
            f.write(data['html_penha'])
            
        with open('outras.html', 'w', encoding='utf-8') as f:
            f.write(data['html_outras'])
            
        with open('noivos.html', 'w', encoding='utf-8') as f:
            f.write(data['html_noivos'])
        
        # Salva JSON p√∫blico para uso via JavaScript
        public_data = {{
            'penha_events_count': data['penha_events_count'],
            'outras_events_count': data['outras_events_count'],
            'noivos_events_count': data['noivos_events_count'],
            'total_events': data['total_events'],
            'last_update': data['last_update'],
            'generated_at': data['generated_at'],
            'html_penha': data['html_penha'],
            'html_outras': data['html_outras'],
            'html_noivos': data['html_noivos']
        }}
        
        with open('events.json', 'w', encoding='utf-8') as f:
            json.dump(public_data, f, indent=2, ensure_ascii=False)
        
        print("‚úÖ Arquivos HTML gerados com sucesso")
        print(f"üìÑ index.html (p√°gina completa)")
        print(f"üìÑ penha.html ({data['penha_events_count']} eventos)")
        print(f"üìÑ outras.html ({data['outras_events_count']} eventos)") 
        print(f"üìÑ noivos.html ({data['noivos_events_count']} eventos)")
        print(f"üìÑ events.json (dados para JavaScript)")
        EOF
        
    - name: üìã Generate README
      run: |
        cat > README.md << 'EOF'
        # üèõÔ∏è Eventos Sympla - Igreja da Penha
        
        > Sistema automatizado com 3 tipos de cursos: Pais/Padrinhos + Noivos
        
        ## üìä Status Atual
        
        - **Pais e Padrinhos - Igreja da Penha**: Domingos √†s 15:00
        - **Pais e Padrinhos - Outras Igrejas**: Domingos √†s 14:00, Segunda/Quinta √†s 11:00
        - **Cursos de Noivos**: S√°bados √†s 14:00
        - **√öltima Atualiza√ß√£o**: Via GitHub Actions
        
        ## üöÄ URLs Dispon√≠veis
        
        - **P√°gina Completa**: https://SEU-USUARIO.github.io/SEU-REPOSITORIO/
        - **Igreja da Penha**: https://SEU-USUARIO.github.io/SEU-REPOSITORIO/penha.html
        - **Outras Igrejas**: https://SEU-USUARIO.github.io/SEU-REPOSITORIO/outras.html
        - **Cursos de Noivos**: https://SEU-USUARIO.github.io/SEU-REPOSITORIO/noivos.html
        - **Dados JSON**: https://SEU-USUARIO.github.io/SEU-REPOSITORIO/events.json
        
        ## üíª Uso no Wix
        
        ### P√°gina Completa (3 se√ß√µes)
        ```html
        <iframe src="https://SEU-USUARIO.github.io/SEU-REPOSITORIO/" 
                width="100%" height="900" frameborder="0"></iframe>
        ```
        
        ### Igreja da Penha apenas
        ```html
        <iframe src="https://SEU-USUARIO.github.io/SEU-REPOSITORIO/penha.html" 
                width="100%" height="400" frameborder="0"></iframe>
        ```
        
        ### Outras Igrejas apenas
        ```html
        <iframe src="https://SEU-USUARIO.github.io/SEU-REPOSITORIO/outras.html" 
                width="100%" height="400" frameborder="0"></iframe>
        ```
        
        ### Cursos de Noivos apenas
        ```html
        <iframe src="https://SEU-USUARIO.github.io/SEU-REPOSITORIO/noivos.html" 
                width="100%" height="400" frameborder="0"></iframe>
        ```
        
        ## üîÑ Atualiza√ß√µes Autom√°ticas
        
        - **Frequ√™ncia**: A cada 6 horas (00:00, 06:00, 12:00, 18:00 UTC)
        - **Fonte**: API oficial do Sympla
        - **Tecnologia**: GitHub Actions + Python
        - **Status**: 100% independente
        
        ---
        
        ‚ö° **4 p√°ginas HTML** | üé® **Design responsivo** | üì± **Mobile-friendly**
        EOF
        
    - name: üîç Check for changes
      id: changes
      run: |
        # Configura git
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # Adiciona arquivos ao staging
        git add index.html penha.html outras.html noivos.html events.json README.md
        
        # Verifica se h√° mudan√ßas
        if [ -n "$(git diff --cached)" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Mudan√ßas detectadas nos eventos"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è Nenhuma mudan√ßa detectada nos eventos"
        fi
        
    - name: üì§ Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git commit -m "üîÑ Atualiza√ß√£o autom√°tica - $(date '+%d/%m/%Y %H:%M UTC')"
        git push
        echo "‚úÖ Eventos atualizados e publicados no GitHub Pages"
        
        # Mostra resumo
        echo "üìä Resumo da atualiza√ß√£o:"
        python -c "
        import json
        with open('events-data.json') as f:
            data = json.load(f)
        print(f'‚Ä¢ Total: {data[\"total_events\"]} eventos')
        print(f'‚Ä¢ Igreja da Penha: {data[\"penha_events_count\"]} eventos')  
        print(f'‚Ä¢ Outras Igrejas: {data[\"outras_events_count\"]} eventos')
        print(f'‚Ä¢ Cursos de Noivos: {data[\"noivos_events_count\"]} eventos')
        "
        
    - name: üìù Create deployment summary
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "## üéâ Eventos Atualizados com Sucesso" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        python -c "
        import json
        with open('events-data.json') as f:
            data = json.load(f)
        print(f'**üìä Total de eventos**: {data[\"total_events\"]}')
        print(f'**üèõÔ∏è Igreja da Penha**: {data[\"penha_events_count\"]} eventos')
        print(f'**‚õ™ Outras Igrejas**: {data[\"outras_events_count\"]} eventos')
        print(f'**üíí Cursos de Noivos**: {data[\"noivos_events_count\"]} eventos')
        print(f'**üïí Atualiza√ß√£o**: {data[\"generated_at\"]}')
        print('')
        print('**üîó URLs dispon√≠veis:**')
        print('- [P√°gina Completa](https://{{{{ github.repository_owner }}}}.github.io/{{{{ github.event.repository.name }}}})')
        print('- [Igreja da Penha](https://{{{{ github.repository_owner }}}}.github.io/{{{{ github.event.repository.name }}}}/penha.html)')
        print('- [Outras Igrejas](https://{{{{ github.repository_owner }}}}.github.io/{{{{ github.event.repository.name }}}}/outras.html)')
        print('- [Cursos de Noivos](https://{{{{ github.repository_owner }}}}.github.io/{{{{ github.event.repository.name }}}}/noivos.html)')
        " >> $GITHUB_STEP_SUMMARY
